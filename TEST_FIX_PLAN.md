# テスト修正計画 (再改訂)

前回までの対応で `tests/setup.ts` に WebCrypto polyfill を追加し、JWT 生成処理では環境変数を都度参照するようリファクタリングしました。しかし `jose` ライブラリを利用したままでは `payload must be an instance of Uint8Array` エラーが解消できず、`jsonwebtoken` へ置き換えを試みたものの、テストが想定する挙動（秘密鍵未設定時のエラーなど）が変わり失敗が増えてしまいました。

現状、JWT 周りのテストが多数失敗しており、login API も連動してエラーになります。加えて cart フローの一部テストも act ラップ不足で warning が出ています。

## 今後の方針

1. **JWT 実装を `jose` に戻しつつテスト専用のモックを利用**
   - `jose` の `SignJWT` と `jwtVerify` をテスト時だけモックし、単純なトークン文字列を返すようにする。
   - ライブラリ自体の挙動検証は行わず、アプリのロジックだけをテスト対象にする。
2. **セッション ID 生成や Cookie 周りのモック強化**
   - `createSession` で使用する `uuid` をモックして固定値を返す。
   - `next/headers` の `cookies` API もモックし、副作用を完全に排除する。
3. **Cart テストの調整**
   - React の state 更新が `act()` でラップされていない箇所を修正し Warning を除去する。

これらの対応でまずテストの安定化を図り、E2E テストへ進める予定です。JWT の本格的な検証は統合テスト側で行う方向に切り替えます。
